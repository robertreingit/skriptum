# Einführung 

```{r}
#| echo: false
#| warning: false
#| message: false
source('_common.R')
library(tibble)
library(knitr)
library(ggplot2)
```

Im Folgenden beschäftigen wir uns mit experimentellen Design. D.h. wir untersuchen wie wir ein Experiment aus statistischer Sicht erstellen sollten um die Wahrscheinlichkeit einen bestimmten Effekt zu beobachten möglichst Effizient zu erhöhen. Eine zentrale Größe wird dabei immer wieder der Standardfehler $\sigma_e$ der jeweiligen Statistik spielen die wählen um einen bestimmten Effekt zu untersuchen. Daher fangen wir erst einmal mit einem einfachen Beispiel an.

## Zuteilung der Stichprobengrößen in zwei Gruppen

Die folgenden Beispiel sind alle aus @goos2011 entnommen. Wir möchten den Unterschied bezüglich des Mittelwerts zwischen zwei Gruppen $1$ und $2$ untersuchen. In Gruppe $1$ haben wir eine Stichprobengröße von $n_1$ und entsprechend eine Stichprobegröße $n_2$ in Gruppe $2$. Den Unterschied zwischen den beiden Mittelwerten aus den Gruppen berechnen wir wie bekannt nach.

\begin{equation}
D = \bar{X}_1 - \bar{X}_2
\end{equation}

Um die Wahrscheinlichkeit zu erhöhen einen relevanten Unterschied $D$ zwischen den Gruppen zu finden sollten wir das Design des Experiments so wählen, dass die Varianz $\sigma^2(D)$ bzw. der Standardfehler $\sigma_e(D)$ von $D$ möglichst klein wird. Umso kleiner der Standardfehler umso geringer sind die Streuungen in den Stichprobenverteilung und umso geringer ist die Unsicherheit. Die Varianz $\sigma^2(D)$ berechnet sich nach:

\begin{equation}
\sigma^2(D) = \frac{\sigma_1^2}{n_1} + \frac{\sigma_2^2}{n_2}
\end{equation}

Der Standardfehler von $D$ ist dementsprechend die Wurzel der Varianz. Schauen wir uns an, was dies in einem konkreten Fall bedeutet. Wir gehen von einer Gesamtstichprobengröße von $N = 12$ und der Einfachheit halber von einer Standardabweichungen in beiden Population von $\sigma^2_1 = \sigma^2_2 = \sigma^2 = 1$ aus.


```{r}
#| tbl-cap: "Abhängigkeit der Varianz und des Standardfehler von $D$ mit der Stichprobenverteilung bei gleicher Varianz"
#| label: tbl-ed-basics-sample-01

n <- 12
var_d12 <- function(n_1,sigma_1,sigma_2) sigma_1/n_1 - sigma_2/(n_1-12)
var_d <- function(n_1) var_d12(n_1, 1, 1)
tibble(n_1 = 1:11, n_2 = seq(11,1), v_d = var_d(n_1), se_d = sqrt(v_d), eff = min(v_d)/v_d) |> 
  kable(
    booktabs = TRUE,
    linesep = '',
    escape = FALSE,
    col.names = c('$n_1$','$n_2$', '$\\sigma^2(D)$', '$\\sigma_e(D)$', 'Effizienz'),
    digits = 2
  )
```

In @tbl-ed-basics-sample-01 sind die Varianz $\sigma^2(D)$ und der Standardfehler $\sigma_e(D)$ gegen die Stichprobenverteilung abgetragen. Wir können sehen, dass bei gleicher Stichprobenanzahl in beiden Gruppen die Varianz und somit auch der Standardfehler den kleinsten Wert annehmen. In der fünften Spalte von @tbl-ed-basics-sample-01 ist ein Wert Effizient eingetragen. Dieser Wert berechnet sich aus dem Verhältnis der kleinstmöglichen Varianz zur jeweiligen Varianz. Wir können an diesem Wert abschätzen, das ein Design bei dem in einer der Gruppen nur eine einzige Person ist, die Effizienz nur noch ein Drittel dessen ist, was bei einer gleichmäßigen Stichprobenverteilung zu errreichen ist. D.h. so weit ist die übliche Herangehensweise, beide Gruppen möglichst gleichgroß zu gestalten vollkommmen sinnvoll.

Schauen wir uns als Nächstes an, wie das aussieht wenn die Stichprobengröße $N$ anwächst. In @fig-ed-basics-sample-01 ist der Standardfehler $\sigma_e(D)$ gegen verschiedene Zuteilungen der Stichproben in die beiden Gruppen für verschiedene Stichprobengrößen abgebildet.

```{r}
#| fig-cap: "Zusammenhang zwischen den Standardfehler und Verteilung der Stichproben in die Gruppen für verschiedene Stichprobengrößen"
#| label: fig-ed-basics-sample-01

sigma <- 1
foo <- function(p, N, sigma) {
  sqrt(1/(p*N) + 1/((1-p)*N))
}
bar <- function(p, n, sigma) {
  purrr::map_dbl(p, ~foo(.x, n, sigma))
}
n_s <- c(10, 20, 40, 60, 80, 100)
p_s <- seq(0.1, 0.9, 0.05)
t_n <- tibble(
  p = rep(p_s, length(n_s)),
  y = purrr::as_vector(purrr::map(n_s, ~bar(p_s, .x, sigma))),
  n = as.character(rep(n_s, each=(length(p_s)))))
p_1 <- ggplot(t_n, aes(p,y)) + 
  geom_line(linewidth=1.3, aes(color=n)) +
  scale_color_manual("N", breaks = unique(t_n$n),
                     values = RColorBrewer::brewer.pal(length(n_s), "Set3")) +
  labs(x = expression(paste('Proportion der', n[1])),
       y = expression(sqrt(frac(1,n[1])~+~frac(1,n[2])))) 
print(p_1)
```

In @fig-ed-basics-sample-01 ist zu sehen, das das bei gleichen Varianzen die gleichmäßige Verteilung der Stichprobe in die beiden Gruppen immer diejenige mit dem kleinsten Standardfehler ist. Der Standardfehler nimmt natürlich mit der Größe der Stichprobe ab. Allerdings nimmt auch die Größe der Verschlechterung bei ungleicher Verteilung mit der Größe der Stichprobe ab. Daher, wenn wir eine große Stichprobe haben, dann ist die gleichmäßige Verteilung der Stichproben weniger wichtig als bei kleinen Stichprobengrößen.

Schauen wir uns daher als nächsten Fall an, was passiert wenn die Varianzen in den beiden Gruppen nicht mehr gleich sind. Sei zum Beispiel $\sigma^2 = 1$ und $\sigma^2 = 9$. Also ein recht extremer Unterschied zwischen den beiden Gruppen.

```{r}
#| tbl-cap: "Abhängigkeit der Varianz und des Standardfehler von $D$ mit der Stichprobenverteilung bei ungleicher Varianz $\\sigma_1^2 = 1, \\sigma_2^2=9$"
#| label: tbl-ed-basics-sample-02

n <- 12
sigma_1 <- 1
sigma_2 <- 9
tibble(n_1 = 1:11, n_2 = seq(11,1), v_d = var_d12(n_1, sigma_1, sigma_2), se_d = sqrt(v_d), eff = min(v_d)/v_d) |> 
  kable(
    booktabs = TRUE,
    linesep = '',
    escape = FALSE,
    col.names = c('$n_1$','$n_2$', '$\\sigma^2(D)$', '$\\sigma_e(D)$', 'Effizienz'),
    digits = 2
  )
```

In @tbl-ed-basics-sample-02 sind wieder die verschiedenen Werte für $\sigma^2(D)$, $\sigma_e(D)$ und die Effizienz berechnet worden. Wir können sehen, dass jetzt nicht mehr das Design mit gleichgroßen Stichproben optimal ist, sondern das Design mit $n_1 = 3$ und $n_2 = 9$. D.h. die ungleiche Varianz in den beiden Gruppen hat dazu geführt, dass der minimale Standardfehler dann eingenommen wird, wenn wir einen größere Stichprobe aus Gruppe $2$ ziehen als aus Gruppe $1$.

Wenn wir diese nicht gewusst hätten und in beiden Gruppen wieder mit $n_i = 6$ gearbeitet hätten, hätten wir somit $20\%$ Effizienz eingebüßt. Intuitiv macht diese ungleiche Verteilung auch Sinn. Da die Varianz in Gruppe $2$ größer ist, ist auch unserer Unsicherheit über den Mittelwert in dieser Gruppe größer. Um diese Unsicherheit auszugleichen erhöhen wir die Stichprobenanzahl im Verhältnis zu Gruppe $1$ um mehr Information über die diese Gruppe zu erhalten. Intuitiv macht diese ungleiche Verteilung auch Sinn. Da die Varianz in Gruppe $2$ größer ist, ist auch unserer Unsicherheit über den Mittelwert in dieser Gruppe größer. Um diese Unsicherheit auszugleichen erhöhen wir die Stichprobenanzahl im Verhältnis zu Gruppe $1$ um mehr Information über die diese Gruppe zu erhalten.

Schauen wir uns ein Beispiel an, bei dem die Unterschied in den Varianzen zwischen den beiden Gruppen nicht ganz so extrem sind (siehe @tbl-ed-basics-sample-03).

```{r}
#| tbl-cap: "Abhängigkeit der Varianz und des Standardfehler von $D$ mit der Stichprobenverteilung bei ungleicher Varianz $\\sigma_1^2 = 1, \\sigma_2^2=2$"
#| label: tbl-ed-basics-sample-03

n <- 12
sigma_1 <- 1
sigma_2 <- 2
tibble(n_1 = 1:11, n_2 = seq(11,1), v_d = var_d12(n_1, sigma_1, sigma_2), se_d = sqrt(v_d), eff = min(v_d)/v_d) |> 
  kable(
    booktabs = TRUE,
    linesep = '',
    escape = FALSE,
    col.names = c('$n_1$','$n_2$', '$\\sigma^2(D)$', '$\\sigma_e(D)$', 'Effizienz'),
    digits = 2
  )
```

In @tbl-ed-basics-sample-03 sehen wir wieder, das das effizienteste Design nicht gleich große Stichproben in den beiden Gruppen hat, sondern hier würde das Design mit $n_1 = 5$ und $n_2 = 7$ den niedrigsten Standardfehler zeigen. Der Verlust an Effizienz bei gleich großen Gruppen wäre hier praktisch zu vernachlässigen. D.h. wenn wir keine genauen Information haben wie sich die Varianzen in den beiden Gruppen verhalten, aber wir keine großen Unterschiede erwarten, dann sind wir mit gleichgroßen Gruppen wahrscheinlich oft gut bedient.

Untersuchen wir die Effizienz noch einmal aus einer anderen Perspektive, nämlich des Budget das uns zur Verfügung steht. Nehmen wir an wir müssen die Untersuchung in einem Speziallabor durchführen und wir haben nur eine begrenzte Zeit zur Verfügung. Wir untersuchen wieder zwei Gruppen bei denen aber die Vorbereitung des Experiment doppelt solange für Gruppe $2$ dauert im Vergleich zu Gruppe $1$. Zum Beispiel in Gruppe $1$ benötigen wir das Labor für eine Stunde während wir für Teilnehmerinnen und Teilnehmer aus Gruppe $2$ zwei Stunden benötigen. In Gruppe $2$ ist vielleicht eine spezielle Patientenpopulation bei der wir mehr Zeit einplanen müssen. Wir haben aber nur insgesamt $24$ Stunden das Labor zu Verfügung. Wir setzen wieder $\sigma^2 = 1$ an. Wie sollten wir die Gruppengrößen zuteilen?

Wir können jetzt nicht einfach die gleiche Tabelle wie in den obigen Fällen benutzen, da wir unser Zeitbudget beachten müssen. Mit etwas ausprobieren kommen wir zu folgendem Ergebnis.

```{r}
#| tbl-cap: "Abhängigkeit der Varianz und des Standardfehler von $D$ bei $\\sigma_i^2 = 1$ und Budgetbeschränkungen von $24$ Stunden"
#| label: tbl-ed-basics-sample-04

n <- 12
tibble(n_1 = seq(22,2,-2), n_2 = 1:11, zeit = n_1  + 2*n_2, v_d = 1/n_1 + 1/n_2, se_d = sqrt(v_d), eff = min(v_d)/v_d) |>  
  kable(
    booktabs = TRUE,
    linesep = '',
    escape = FALSE,
    col.names = c('$n_1$','$n_2$', 'Kosten', '$\\sigma^2(D)$', '$\\sigma_e(D)$', 'Effizienz'),
    digits = 2
  )
```

Wir sehen wieder in @tbl-ed-basics-sample-04, dass eine ungleiche Verteilung in die Gruppen die höchste Effizienz hat. Der Effekt hier, ist dass wir hier eine Balance finden müssen zwischen den größten Anzahl einer Teilnehmerinnen und Teilnehmer und der Ungleichheit der Stichprobengrößen.

Zusammenfassend können wir sagen, dass bei Vergleichen zweier Gruppen das Design mit gleich großen Stichproben in beiden Gruppen die Beste Wahl ist. In Abhängigkeit wie sich die Varianzen zwischen den Gruppen verhalten und oder auch welche Randbedingungen wir für die Durchführung des Experiment haben können die Aussagen sehr unterschiedlich sein. Daher macht es Sinn sich für seinen speziellen Fall etwas Gedanken zu machen welches Design den bestmöglichen Output liefert und vielleicht nicht einfach nur ein Standarddesign aus der Schublade. Die Problematik eine informierte Entscheidung diesbezüglich zu treffen wird in den folgenden Kapitel immer wieder aufgegriffen.


